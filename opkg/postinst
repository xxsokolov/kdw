#!/bin/sh

# KDW Bot Post-Installation Script (FINAL, syslog-aware)

# --- Functions ---
echo_step() {
  echo "-> $1"
}
echo_success() {
  # Green color
  printf "\033[0;32m[OK] %s\033[0m\n" "$1"
}
echo_error() {
  # Red color
  printf "\033[0;31m[ERROR] %s\033[0m\n" "$1"
  exit 1
}

# --- 1. Argument Parsing ---
BOT_TOKEN=""
USER_ID=""
PYTHON_EXEC=""

while [ "$1" != "" ]; do
    case $1 in
        --token) shift; BOT_TOKEN=$1 ;;
        --user-id) shift; USER_ID=$1 ;;
        --python-exec) shift; PYTHON_EXEC=$1 ;;
    esac
    shift
done

# --- 2. Interactive Configuration ---
echo_step "Настройка конфигурации..."
if [ -z "$BOT_TOKEN" ]; then
  echo "Пожалуйста, введите данные для настройки бота:"
  printf "1. Токен вашего Telegram бота: "
  read BOT_TOKEN
  if [ -z "$BOT_TOKEN" ]; then echo_error "Токен не может быть пустым."; fi

  printf "2. Ваш Telegram User ID: "
  read USER_ID
  if [ -z "$USER_ID" ]; then echo_error "User ID не может быть пустым."; fi
else
  echo "Используются параметры, переданные при запуске."
fi

# --- 3. Validate Dependencies & Token ---
echo_step "Проверка токена и зависимостей..."
if [ -z "$PYTHON_EXEC" ]; then
    if ! command -v python3 > /dev/null; then echo_error "Python3 не найден."; fi
    PYTHON_EXEC=$(command -v python3)
fi
if ! command -v curl > /dev/null; then echo_error "curl не найден."; fi
if ! command -v jq > /dev/null; then echo_error "jq не найден."; fi

API_URL="https://api.telegram.org/bot$BOT_TOKEN/getMe"
RESPONSE=$(curl -s "$API_URL")
OK_STATUS=$(echo $RESPONSE | jq -r '.ok')

if [ "$OK_STATUS" != "true" ]; then
  echo_error "Неверный токен. Telegram API вернул ошибку:"
  echo "$RESPONSE"
  exit 1
fi
BOT_USERNAME=$(echo $RESPONSE | jq -r '.result.username')
echo_success "Токен верный. Бот: @$BOT_USERNAME"

# --- 4. Create Config File ---
echo_step "Создание конфигурационного файла kdw.cfg..."
PROJECT_DIR="/opt/etc/kdw"
CONFIG_FILE="${PROJECT_DIR}/kdw.cfg"

cat > $CONFIG_FILE << EOF
[telegram]
token = $BOT_TOKEN
access_ids = [$USER_ID]
[installer]
script_path = ${PROJECT_DIR}/scripts/install.sh
network_interface = br0
[keenetic]
host = 127.0.0.1
port = 80
user = admin
password =
[shadowsocks]
path = /opt/etc/shadowsocks
file_mask = *.json
EOF
echo_success "Конфигурационный файл создан."

# --- 5. Create Service ---
echo_step "Создание службы автозапуска S99kdwbot..."
SERVICE_DIR="/opt/etc/init.d"
SERVICE_FILE="${SERVICE_DIR}/S99kdwbot"
LOG_DIR="/opt/var/log"

mkdir -p "$SERVICE_DIR"
mkdir -p "$LOG_DIR"

if [ -f "$SERVICE_FILE" ]; then
    sh "$SERVICE_FILE" stop
fi

cat > $SERVICE_FILE << EOF
#!/bin/sh
# KDW Bot Service (syslog-aware with fallback)
BOT_PATH="${PROJECT_DIR}/kdw_bot.py"
PYTHON_EXEC="$PYTHON_EXEC"
PID_FILE="/var/run/kdw_bot.pid"
LOG_FILE="${LOG_DIR}/kdw_bot.log" # Файл для stderr и traceback

start() {
    if [ -f "\$PID_FILE" ] && ps | grep -q "^\s*\$(cat \$PID_FILE)\s"; then
        echo "KDW Bot is already running."
        return
    fi
    echo "Starting KDW Bot..."
    # Основной лог идет в syslog, а ошибки и traceback - в файл.
    \$PYTHON_EXEC \$BOT_PATH >> \$LOG_FILE 2>&1 &
    echo \$! > \$PID_FILE
}

stop() {
    if [ ! -f "\$PID_FILE" ]; then
        echo "KDW Bot is not running (PID file not found)."
        return
    fi

    PID=\$(cat \$PID_FILE)
    if ! ps | grep -q "^\s*\$PID\s"; then
        echo "KDW Bot is not running (stale PID file found)."
        rm -f \$PID_FILE
        return
    fi

    echo "Stopping KDW Bot (PID: \$PID)..."
    kill \$PID
    rm -f \$PID_FILE
}

case "\$1" in
    start|restart)
        stop; sleep 2; start
        ;;
    stop)
        stop
        ;;
    *)
        echo "Usage: \$0 {start|stop|restart}"
        exit 1
esac
EOF
chmod +x $SERVICE_FILE
echo_success "Служба создана."

# --- 6. Final ---
echo_step "Запуск бота..."
$SERVICE_FILE start
sleep 5

# --- 7. Проверка успешного запуска ---
echo_step "Проверка статуса запущенного бота..."
if [ -f /var/run/kdw_bot.pid ] && ps | grep -q "^\s*$(cat /var/run/kdw_bot.pid)\s"; then
    echo_success "Процесс бота успешно запущен."
    echo ""
    echo "--- Что дальше? ---"
    echo "1. Откройте Telegram и найдите вашего бота: @${BOT_USERNAME}"
    echo "2. Отправьте ему команду /start."
    echo "3. Следите за логами в системном журнале Keenetic."
    echo "4. Для отладки ошибок смотрите файл: /opt/var/log/kdw_bot.log"
    echo ""
else
    echo_error "Не удалось запустить процесс бота. Пожалуйста, проверьте лог-файл:"
    echo "   less /opt/var/log/kdw_bot.log"
    exit 1
fi

exit 0
