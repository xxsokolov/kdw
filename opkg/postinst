#!/bin/sh

# KDW Bot Post-Installation Script (SAFE VERSION)

# --- Functions ---
echo_step() {
  echo "-> $1"
}
echo_success() {
  echo "[OK] $1"
}
echo_error() {
  echo "[ERROR] $1"
  exit 1
}

# --- 1. Argument Parsing ---
BOT_TOKEN=""
USER_ID=""

while [ "$1" != "" ]; do
    case $1 in
        --token)
            shift
            BOT_TOKEN=$1
            ;;
        --user-id)
            shift
            USER_ID=$1
            ;;
    esac
    shift
done

# --- 2. Interactive Configuration ---
echo_step "Настройка конфигурации..."
if [ -z "$BOT_TOKEN" ]; then
  echo "Пожалуйста, введите данные для настройки бота:"
  printf "1. Токен вашего Telegram бота: "
  read BOT_TOKEN
  if [ -z "$BOT_TOKEN" ]; then echo_error "Токен не может быть пустым."; fi

  printf "2. Ваш Telegram User ID: "
  read USER_ID
  if [ -z "$USER_ID" ]; then echo_error "User ID не может быть пустым."; fi
else
  echo "Используются параметры, переданные при запуске."
fi

# --- 3. Validate Token ---
echo_step "Проверка токена бота..."
API_URL="https://api.telegram.org/bot$BOT_TOKEN/getMe"
RESPONSE=$(curl -s "$API_URL")
OK_STATUS=$(echo $RESPONSE | jq -r '.ok')

if [ "$OK_STATUS" != "true" ]; then
  echo_error "Неверный токен. Telegram API вернул ошибку:"
  echo "$RESPONSE"
  exit 1
fi
BOT_USERNAME=$(echo $RESPONSE | jq -r '.result.username')
echo_success "Токен верный. Бот: @$BOT_USERNAME"

# --- 4. Create Config File ---
echo_step "Создание конфигурационного файла kdw.cfg..."
PROJECT_DIR="/opt/etc/kdw"
CONFIG_FILE="${PROJECT_DIR}/kdw.cfg"

cat > $CONFIG_FILE << EOF
[telegram]
token = $BOT_TOKEN
access_ids = [$USER_ID]
[installer]
script_path = ${PROJECT_DIR}/scripts/install.sh
network_interface = br0
[keenetic]
host = 127.0.0.1
port = 80
user = admin
password =
[shadowsocks]
path = /opt/etc/shadowsocks
file_mask = *.json
EOF
echo_success "Конфигурационный файл создан."

# --- 5. Create Service ---
echo_step "Создание службы автозапуска S99kdwbot..."
SERVICE_DIR="/opt/etc/init.d"
SERVICE_FILE="${SERVICE_DIR}/S99kdwbot"

mkdir -p "$SERVICE_DIR"

if [ -f "$SERVICE_FILE" ]; then
    sh "$SERVICE_FILE" stop
fi

cat > $SERVICE_FILE << EOF
#!/bin/sh
# KDW Bot Service
BOT_PATH="${PROJECT_DIR}/kdw_bot.py"
LOG_FILE="/opt/var/log/kdw_bot.log"

start() {
    # Проверяем, не запущен ли уже процесс
    if ps | grep "$BOT_PATH" | grep -v grep > /dev/null; then
        echo "KDW Bot is already running."
        return
    fi
    echo "Starting KDW Bot..."
    # Запускаем весь цикл в фоне ОДИН РАЗ
    while true; do
        python3 \$BOT_PATH >> \$LOG_FILE 2>&1
        echo "KDW Bot process exited. Restarting in 15 seconds..." >> \$LOG_FILE
        sleep 15
    done &
}

stop() {
    echo "Stopping KDW Bot..."
    # Надежный способ найти и убить процесс
    PID=\$(ps | grep "$BOT_PATH" | grep -v grep | awk '{print \$1}')
    if [ -n "\$PID" ]; then
        kill \$PID
    fi
}

case "\$1" in
    start|restart)
        stop; sleep 2; start
        ;;
    stop)
        stop
        ;;
    *)
        echo "Usage: \$0 {start|stop|restart}"
        exit 1
esac
EOF
chmod +x $SERVICE_FILE
echo_success "Служба создана."

# --- 6. Final ---
echo_step "Запуск бота..."
$SERVICE_FILE start

echo ""
echo_success "Установка и настройка завершены!"
echo ""
echo "--- Что дальше? ---"
echo "1. Откройте Telegram и найдите вашего бота: @${BOT_USERNAME}"
echo "2. Отправьте ему команду /start, чтобы появилось главное меню."
echo ""

exit 0
