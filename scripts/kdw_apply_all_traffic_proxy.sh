#!/bin/sh

# =================================================================
# KDW Firewall Rule Applier (All-Traffic Mode)
#
# Описание:
#   Применяет правила iptables для перенаправления всего
#   трафика через один указанный прокси.
#
# Использование:
#   sh kdw_apply_all_traffic_proxy.sh <proxy_type> <port>
#   Пример: sh kdw_apply_all_traffic_proxy.sh trojan 10829
# =================================================================

# --- Параметры ---
PROXY_TYPE=$1
PORT=$2

if [ -z "$PROXY_TYPE" ] || [ -z "$PORT" ]; then
    echo "Ошибка: Не указан тип прокси и/или порт."
    echo "Использование: $0 <proxy_type> <port>"
    exit 1
fi

# Директория со скриптами
SCRIPT_DIR=$(dirname "$0")

echo "--- Применение правил Firewall для всего трафика через $PROXY_TYPE ---"
echo ""

# --- Шаг 1: Полная очистка старых правил ---
echo "1. Выполняю полную очистку предыдущих правил KDW..."
sh "${SCRIPT_DIR}/kdw_flush_proxy_rules.sh"
echo ""

# --- Шаг 2: Создание правила для всего трафика ---
echo "2. Создаю правило для перенаправления всего трафика на порт $PORT..."

# Исключения: не перенаправляем трафик, предназначенный для
# - Приватных сетей (192.168.0.0/16, 10.0.0.0/8, 172.16.0.0/12)
# - Loopback-интерфейса (127.0.0.0/8)
# - Широковещательных адресов
EXCLUSIONS="-d 0.0.0.0/8 -d 127.0.0.0/8 -d 10.0.0.0/8 -d 172.16.0.0/12 -d 192.168.0.0/16 -d 224.0.0.0/4 -d 240.0.0.0/4"

# Формируем правило
# Мы используем -p tcp, так как большинство прокси (включая Trojan) не поддерживают UDP "из коробки" для всего трафика.
RULE_SPEC="-t nat -p tcp $EXCLUSIONS -j REDIRECT --to-port $PORT"

# Добавляем правило
if ! iptables -C PREROUTING $RULE_SPEC >/dev/null 2>&1; then
    iptables -I PREROUTING 1 $RULE_SPEC
    echo "  - Правило создано."
else
    echo "  - Правило уже существует."
fi
echo ""

echo "✅ Применение правил для всего трафика завершено."
exit 0
