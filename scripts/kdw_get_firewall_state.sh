#!/bin/sh

# =================================================================
# KDW Firewall State Getter
#
# Описание:
#   Определяет текущий режим работы правил firewall KDW
#   и выводит одно из трех значений:
#   - lists_only
#   - all_traffic
#   - flushed
# =================================================================

# --- Проверка режима "Всего трафика" ---
# Ищем характерное правило, которое перенаправляет трафик, ИСКЛЮЧАЯ локальные сети.
if iptables-save -t nat | grep -q -- "-d 192.168.0.0/16 -j REDIRECT"; then
    echo "all_traffic"
    exit 0
fi

# --- Проверка режима "По спискам" ---
# Ищем любое правило, использующее наши ipset-списки.
if iptables-save -t nat | grep -q -- "--match-set kdw_"; then
    echo "lists_only"
    exit 0
fi

# --- Если ничего не найдено ---
echo "flushed"
exit 0
